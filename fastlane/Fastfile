lane :select_new_release_version do |options|
  prepare_lane_options(
    options: options,
    required_keys: [
      :current_version_number
    ]
  )
  version_number = options[:current_version_number]
  UI.error "You must update your version '#{version_number}'"
  bump_type = UI.select("Select version bump type: ", ["patch", "minor", "major"])
  get_next_version_number(
    version_number: version_number,
    bump_type: bump_type
  )
  lane_context[SharedValues::NEXT_BUILD_NUMBER] = "1"
end

lane :select_new_build_number do |options|
  prepare_lane_options(
    options: options,
    required_keys: [
      :current_build_number
    ]
  )
  build_number = options[:current_build_number]
  UI.error "You must update your build number ##{build_number}"
  bump_type = UI.input("Set the build number [press enter to auto-increment] ")
  if bump_type.length == 0
    get_next_build_number(build_number: build_number)
  else
    lane_context[SharedValues::NEXT_BUILD_NUMBER] = bump_type
  end
end

lane :ensure_next_release_version do |options|
  ensure_git_flow_init()
  prepare_lane_options(
    options: options,
    mapping: {
      :prefix_versiontag => {:lane_context => SharedValues::GIT_FLOW_VERSIONTAG_PREFIX},
    },
    required_keys: [
      :current_version_number,
      :current_build_number
    ]
  )
  prefix_versiontag = options[:prefix_versiontag]
  version_number = options[:current_version_number]
  build_number = options[:current_build_number]
  while git_tag_exists(tag: "#{prefix_versiontag}#{version_number}") do
    select_new_release_version(current_version_number: version_number)
    version_number = lane_context[SharedValues::NEXT_VERSION_NUMBER];
    build_number = lane_context[SharedValues::NEXT_BUILD_NUMBER];
  end
  while git_tag_exists(tag: "#{prefix_versiontag}#{version_number}##{build_number}") do
    select_new_build_number(current_build_number: build_number)
    build_number = lane_context[SharedValues::NEXT_BUILD_NUMBER];
  end
  UI.success "Release version '#{version_number}' build ##{build_number} ready"
  lane_context[SharedValues::NEXT_VERSION_NUMBER] = version_number
  lane_context[SharedValues::NEXT_BUILD_NUMBER] = build_number
  lane_context[:DG_RELEASE_TAG] = "#{prefix_versiontag}#{version_number}"
  lane_context[:DG_BUILD_TAG] = "#{prefix_versiontag}#{version_number}##{build_number}"
end

private_lane :prepare_app_release do |options|
  ensure_git_status_clean()
  ensure_git_flow_init()
  prepare_lane_options(
    options: options,
    mapping: {
      :project => {:env_var => "DG_PROJECT"}
    }
  )
  develop_branch = lane_context[SharedValues::GIT_FLOW_DEVELOP_BRANCH]
  if git_branch() != develop_branch
    UI.user_error! "You must run this lane on the '#{develop_branch}' only"
  end
  version_number = get_version_number(xcodeproj: options[:project])
  build_number = get_build_number(xcodeproj: options[:project])
  ensure_next_release_version(
    current_version_number: version_number,
    current_build_number: build_number
  )
  version_number = lane_context[SharedValues::NEXT_VERSION_NUMBER]
  build_number = lane_context[SharedValues::NEXT_BUILD_NUMBER]
  if !UI.confirm("Are you sure to submit release version '#{version_number}' build ##{build_number} ?")
    UI.user_error! "User abort app release"
  end
end

private_lane :send_app_release do |options|
  develop_branch = lane_context[SharedValues::GIT_FLOW_DEVELOP_BRANCH]
  current_version_number = lane_context[SharedValues::VERSION_NUMBER]
  current_build_number = lane_context[SharedValues::BUILD_NUMBER]
  version_number = lane_context[SharedValues::NEXT_VERSION_NUMBER]
  build_number = lane_context[SharedValues::NEXT_BUILD_NUMBER]
  if current_version_number != version_number || current_build_number != build_number
    increment_version_number(
      xcodeproj: options[:project],
      version_number: version_number
    )
    increment_build_number(
      xcodeproj: options[:project],
      build_number: build_number
    )
    git_commit(
      path: ["."],
      message: "Bumped release version '#{version_number}' build ##{build_number}"
    )
  end
  add_git_tag(
    tag: lane_context[:DG_BUILD_TAG]
  )
  push_to_git_remote()
  release_branch = git_branch()
  Actions.sh("git checkout #{develop_branch}")
  Actions.sh("git merge #{release_branch}")
  push_to_git_remote()
end

lane :start_app_release do |options|
  prepare_app_release(options)
  version = lane_context[SharedValues::NEXT_VERSION_NUMBER]
  begin
    git_flow_release(
      action: "start",
      name: version
    )
  rescue
    UI.user_error! "Cannot start release '#{version}', you are probably starting the current release version\n\
    * if you want to update a new build release use the following lane : 'update_app_release'\n\
    * if you want to publish the release use the lane : 'publish_app_release'"
  end
  send_app_release(options)
end

lane :update_app_release do |options|
  prepare_app_release(options)
  develop_branch = lane_context[SharedValues::GIT_FLOW_DEVELOP_BRANCH]
  version_number = lane_context[SharedValues::NEXT_VERSION_NUMBER]
  prefix_release = lane_context[SharedValues::GIT_FLOW_RELEASE_PREFIX]
  release_branch = "#{prefix_release}#{version_number}"
  begin
    Actions.sh("git checkout #{release_branch}")
  rescue
    UI.user_error! "Cannot update release '#{version}', unknown release version\n\
    * first you need to start a new release version with the following lane : 'start_app_release'"
  end
  Actions.sh("git merge #{develop_branch}")
  send_app_release(options)
end
